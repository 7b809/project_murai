<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AniList Anime Extractor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { margin-top: 40px; }
    .anime-card img { border-radius: 10px; }
    .episode-card { 
      cursor: pointer; 
      transition: transform 0.2s, background-color 0.3s;
      border: 2px solid transparent;
    }
    .episode-card:hover { transform: scale(1.05); }
    .fetching { background-color: #dc3545 !important; color: white; } /* red */
    .success { background-color: #28a745 !important; color: white; } /* green */
    .failed { background-color: #6c757d !important; color: white; } /* gray */
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">üé¨ Anime Extractor via AniList</h2>
    <form action="/anime" method="post" class="mb-4">
      <div class="input-group">
        <input type="text" name="anime_id" class="form-control" placeholder="Enter AniList Anime ID (e.g. 15125)" required>
        <button type="submit" class="btn btn-primary">Fetch</button>
      </div>
    </form>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if anime %}
      <div class="card anime-card mb-4">
        {% if anime.coverImage.extraLarge %}
          <img src="{{ anime.coverImage.extraLarge }}" class="card-img-top" alt="Cover">
        {% endif %}
        <div class="card-body">
          <h3 class="card-title">{{ anime.title.english or anime.title.romaji }}</h3>
          <p><b>Season:</b> {{ anime.season }} {{ anime.seasonYear }} | <b>Episodes:</b> {{ anime.episodes or 'N/A' }}</p>
          <p><b>Genres:</b> {{ anime.genres | join(', ') }}</p>
          <p><b>Average Score:</b> {{ anime.averageScore or 'N/A' }}</p>
          <p>{{ anime.description | safe }}</p>
        </div>
      </div>

      <h4>Episodes:</h4>
      <div class="row">
        {% for ep in episodes %}
          <div class="col-6 col-md-3 mb-3">
            <div id="ep-{{ ep }}" class="card episode-card text-center" onclick="fetchEpisode('{{ anime.id }}', '{{ ep }}')">
              <div class="card-body">
                <h5>Episode {{ ep }}</h5>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    async function fetchEpisode(animeId, epNumber) {
      const card = document.getElementById(`ep-${epNumber}`);
      if (card.classList.contains('success')) {
        // already fetched, open the link
        const url = card.dataset.watchUrl;
        if (url) window.open(url, '_blank');
        return;
      }

      card.classList.add('fetching');
      try {
        const res = await fetch(`/watch/${animeId}/${epNumber}`);
        const data = await res.json();

        if (data.status === 'ok' && data.watch_url) {
          card.classList.remove('fetching');
          card.classList.add('success');
          card.dataset.watchUrl = data.watch_url;
          // now clicking again opens the video
          card.onclick = () => window.open(data.watch_url, '_blank');
        } else {
          throw new Error('Failed to fetch URL');
        }
      } catch (err) {
        card.classList.remove('fetching');
        card.classList.add('failed');
        card.querySelector('h5').textContent = `Episode ${epNumber} ‚ùå`;
      }
    }
  </script>
</body>
</html>
